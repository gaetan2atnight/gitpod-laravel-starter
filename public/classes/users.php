<?phprequire_once($_SERVER['DOCUMENT_ROOT']."/classes/functions.php");require_once($_SERVER['DOCUMENT_ROOT'].'/classes/database.php');require_once($_SERVER['DOCUMENT_ROOT'].'/classes/cookies.php');require_once($_SERVER['DOCUMENT_ROOT']."/classes/logs.php");class Users{	var $bd;		/*Constructeur*/	function __construct(){		$bdd = new DataBase();		$this->bd = $bdd->connect();	}		//Identification d'un utilisateur	function ident($id, $pass){		$sql = 'SELECT * '        . ' FROM `start_users` '        . ' WHERE `idUser` = \''.$id.'\' AND `pwd` = \''.sha1($pass).'\'';		if($result = mysqli_query($this->bd,$sql)){			$nb = mysqli_num_rows($result);			if($nb == 0){				return false;			}else{				addLog("Identification - ".$id);				return true;			}		}else{			addLog("Erreur de connexion SQL : ".mysqli_error($this->bd));			return false;		}	}		//Retourne l'id de l'User connecté false sinon	function getConnectedUser(){		$retour = false;		if(existCookie('idUser') && existCookie('pass')){			$idUser = $_COOKIE['idUser'];			$pass = $_COOKIE['pass'];			$bdUser = $this->ident($idUser, $pass);			if($bdUser == true)				$retour = $idUser;		}		return $retour;	}		//Liste des favoris icones d'un utilisateur	function getIconsFavoris($idUser){		$res = array();				$sql = 'SELECT * FROM `favoris` WHERE `idUser` = \''.$idUser.'\' AND (`label` = \'lb_webmail\' OR `label` = \'lb_bank\' OR `label` = \'lb_meteo\' OR `label` = \'lb_tv\')';		$result = mysqli_query($this->bd,$sql) or die(mysqli_error());		while($line = mysqli_fetch_array($result)) {			$res[$line['label']] = $line['adresse'];		}		return $res;	}		//Retourne 1 si l'user veut afficher le tree au démarage, 0 sinon	function getDisplayTree($idUser){				$sql = 'SELECT `displayTree` FROM `start_users` WHERE `idUser` = \''.$idUser.'\'';		$result = mysqli_query($this->bd,$sql) or die(mysqli_error());		while($line = mysqli_fetch_array($result)) {			$res = $line['displayTree'];		}		return $res;	}		//Retourne l'identifiant de l'utilisateur dont le mdp codé est $hash	function getIdByPwd($hash){				$sql = 'SELECT `idUser` FROM `start_users` WHERE `pwd` = \''.$hash.'\'';		$result = mysqli_query($this->bd,$sql) or die(mysqli_error());		$res = false;		while($line = mysqli_fetch_array($result)) {			$res = $line['idUser'];		}		return $res;	}		//Retourne le mail de l'utilisateur a partir de son identifiant	function getMail($id){				$sql = 'SELECT `mail` FROM `start_users` WHERE `idUser` = \''.$id.'\'';		$result = mysqli_query($this->bd,$sql) or die(mysqli_error());		$res = '';		while($line = mysqli_fetch_array($result)) {			$res = $line['mail'];		}		return $res;	}		//Retourne 1 si l'user veut afficher les miniatures au démarage, 0 sinon	function getDisplayThumbs($idUser){				$sql = 'SELECT `displayThumbs` FROM `start_users` WHERE `idUser` = \''.$idUser.'\'';		$result = mysqli_query($this->bd,$sql) or die(mysqli_error());		while($line = mysqli_fetch_array($result)) {			$res = $line['displayThumbs'];		}		return $res;	}		//Envoie 1 si l'user veut afficher le tree au démarage, 0 sinon	function setDisplayTree($idUser, $newDisplayTree){				$sql = 'UPDATE start_users SET displayTree=\''.$newDisplayTree.'\' WHERE idUser = \''.$idUser.'\'';		$result = mysqli_query($this->bd,$sql) or die(mysqli_error());	}		//Envoie 1 si l'user veut afficher les miniatures au démarage, 0 sinon	function setDisplayThumbs($idUser, $newDisplayThumbs){				$sql = 'UPDATE start_users SET displayThumbs=\''.$newDisplayThumbs.'\' WHERE idUser = \''.$idUser.'\'';		$result = mysqli_query($this->bd,$sql) or die(mysqli_error());	}	//Liste des dossiers d'un utilisateur	function getFolders($idUser){		$res = array();				$sql = 'SELECT * FROM favoris WHERE idUser = \''.$idUser.'\' AND adresse = \'folder\' ORDER BY label';		$result = mysqli_query($this->bd,$sql) or die(mysqli_error());		$i=0;		while($line = mysqli_fetch_array($result)) {			$res[$i] = $line['label'];			$i++;		}		return $res;	}		//Liste des favoris d'un utilisateur pour un dossier donné	function getFavorisInFolder($idUser, $folder_name){		$res = array();		$favs = array();				$sql = 'SELECT * FROM `favoris` WHERE `idUser` = \''.$idUser.'\' AND `parent` = \''.$folder_name.'\' ORDER BY `label`';		$result = mysqli_query($this->bd,$sql) or die(mysqli_error());		//On met d'abord les dossiers		while($line = mysqli_fetch_array($result)) {			if($line['label'] != 'lb_webmail' && $line['label'] != 'lb_bank' && $line['label'] != 'lb_meteo' && $line['label'] != 'lb_tv'){				if($line['adresse'] == 'folder')					$res[$line['label']] = $line['adresse'];				else					$favs[$line['label']] = $line['adresse'];			}		}		//Ensuite les favoris		$res+=$favs;		return $res;	}		//Liste des favoris d'un utilisateur pour un dossier donné(pas les dossiers)	function getOnlyFavorisInFolder($idUser, $folder_name){		$res = array();				$sql = 'SELECT * FROM `favoris` WHERE `idUser` = \''.$idUser.'\' AND `parent` = \''.$folder_name.'\' ORDER BY `label`';		$result = mysqli_query($this->bd,$sql) or die(mysqli_error());		while($line = mysqli_fetch_array($result)) {			if($line['label'] != 'lb_webmail' && $line['label'] != 'lb_bank' && $line['label'] != 'lb_meteo' && $line['label'] != 'lb_tv' && $line['adresse'] != 'folder'){				$res[$line['label']] = $line['adresse'];			}		}		return $res;	}		//Liste des tous les favoris d'un utilisateur(pas les dossiers)	function getAllFavoris($idUser){		$result = $this->getOnlyFavorisInFolder($idUser, "root");		$folders = $this->getFolders($idUser);		foreach($folders as $cpt => $label){			$result = array_merge($result, $this->getOnlyFavorisInFolder($idUser, $label));		}		//Tri du tableau par label		ksort($result);		return $result;	}		//Supprime le favoris ou le dossier d'un user	function deleteFavoris($idUser, $label){		$sql = 'SELECT * FROM favoris WHERE idUser = \''.$idUser.'\' AND label = \''.$label.'\'';		$result = mysqli_query($this->bd,$sql);		while($line = mysqli_fetch_array($result)) {			if($line['adresse'] == "folder"){				$content = $this->getFavorisInFolder($idUser, $label);				foreach($content as $label2 => $url){					$this->deleteFavoris($idUser, $label2);				}				//Supression du dossier				$sql_delete = 'DELETE FROM `favoris` WHERE `idUser` = \''.$idUser.'\' AND `label` = \''.$label.'\'';				$result_delete = mysqli_query($this->bd,$sql_delete) or die(mysqli_error());			}else{				$sql_delete = 'DELETE FROM `favoris` WHERE `idUser` = \''.$idUser.'\' AND `label` = \''.$label.'\'';				$result_delete = mysqli_query($this->bd,$sql_delete) or die(mysqli_error());			}		}	}		//Renomme un dossier	function renameFolder($idUser, $old, $new){				//On récupère le dossier parent		$sql = 'SELECT `parent` FROM `favoris` WHERE `idUser` = \''.$idUser.'\' AND `label` = \''.$old.'\'';		$result = mysqli_query($this->bd,$sql) or die(mysqli_error());		while($line = mysqli_fetch_array($result)) {			$parent = $line['parent'];		}		if(isset($parent) && !empty($parent) && isset($new) && !empty($new)){			//Supression du dossier			$sql = 'DELETE FROM `favoris` WHERE `idUser` = \''.$idUser.'\' AND `label` = \''.$old.'\'';			$result = mysqli_query($this->bd,$sql) or die(mysqli_error());			//Création du nouveau dossier			$sql = 'INSERT INTO `favoris` (`label`, `adresse`, `parent`, `idUser`) VALUES ('.qs($new).', \'folder\', '.qs($parent).', '.qs($idUser).');';			mysqli_query($this->bd,$sql);			//MAJ dans les favoris			$sql = 'UPDATE `favoris` SET  `parent`  = \''.$new.'\' WHERE `parent` = \''.$old.'\' AND `idUser` = \''.$idUser.'\';';			mysqli_query($this->bd,$sql) or die(mysqli_error());		}	}		//Vérifie si un email existe	function isExistingEmail($email){				$sql = 'SELECT * '        . ' FROM `start_users` '        . ' WHERE `mail` = \''.$email.'\'';		$result = mysqli_query($this->bd,$sql);		$nb = mysqli_num_rows($result);		if($nb == 0){			return false;		}else{			return true;		}	}		//Vérifie si un utilisateur existe	function isExistingUSer($id){				$sql = 'SELECT * '        . ' FROM `start_users` '        . ' WHERE `idUser` = \''.$id.'\'';		$result = mysqli_query($this->bd,$sql);		$nb = mysqli_num_rows($result);		if($nb == 0){			return false;		}else{			return true;		}	}		//Vérifie si un label existe	function isExistingLabel($idUser, $label){				$sql = 'SELECT * FROM favoris WHERE idUser = \''.$idUser.'\' AND label = \''.$label.'\'';		$result = mysqli_query($this->bd,$sql);		$nb = mysqli_num_rows($result);		if($nb == 0){			return false;		}else{			return true;		}	}		//Création d'un utilisateur	function createUser($id, $mdp, $mail){				//Constantes pour les URLs de base		$webmailURL = 'http://mail.google.com/mail/';		$bankURL = 'http://www.groupe.caisse-epargne.com/asp/ci_modele2.aspx?np=caisses_epargne_ci&nv=20080606152546';		$meteoURL = 'http://www.lachainemeteo.com/';		$tvURL = 'http://www.programme-tv.net/';		//Ajout dans la table start_users				$sql = 'INSERT INTO `start_users` (`idUser`, `pwd`, `mail`) VALUES ('.qs($id).', '.qs(sha1($mdp)).', '.qs($mail).');';		mysqli_query($this->bd,$sql);		//Ajouts des favoris de base		$sql = 'INSERT INTO `favoris` (`label`, `adresse`, `parent`, `idUser`) VALUES (\'lb_webmail\', '.qs($webmailURL).', \'root\', '.qs($id).');';		mysqli_query($this->bd,$sql);		$sql = 'INSERT INTO `favoris` (`label`, `adresse`, `parent`, `idUser`) VALUES (\'lb_bank\', '.qs($bankURL).', \'root\', '.qs($id).');';		mysqli_query($this->bd,$sql);		$sql = 'INSERT INTO `favoris` (`label`, `adresse`, `parent`, `idUser`) VALUES (\'lb_meteo\', '.qs($meteoURL).', \'root\', '.qs($id).');';		mysqli_query($this->bd,$sql);		$sql = 'INSERT INTO `favoris` (`label`, `adresse`, `parent`, `idUser`) VALUES (\'lb_tv\', '.qs($tvURL).', \'root\', '.qs($id).');';		mysqli_query($this->bd,$sql);		//Ajout des favoris exemples		$sql = 'INSERT INTO `favoris` (`label`, `adresse`, `parent`, `idUser`) VALUES (\'folder_Informatique\', \'folder\', \'root\', '.qs($id).');';		mysqli_query($this->bd,$sql);		$sql = 'INSERT INTO `favoris` (`label`, `adresse`, `parent`, `idUser`) VALUES (\'www.extremepc.fr\', \'http://www.extremepc.fr\', \'folder_Informatique\', '.qs($id).');';		mysqli_query($this->bd,$sql);		$sql = 'INSERT INTO `favoris` (`label`, `adresse`, `parent`, `idUser`) VALUES (\'www.01net.com\', \'http://www.01net.com\', \'folder_Informatique\', '.qs($id).');';		mysqli_query($this->bd,$sql);		$sql = 'INSERT INTO `favoris` (`label`, `adresse`, `parent`, `idUser`) VALUES (\'www.pcinpact.com\', \'http://www.pcinpact.com\', \'folder_Informatique\', '.qs($id).');';		mysqli_query($this->bd,$sql);		$sql = 'INSERT INTO `favoris` (`label`, `adresse`, `parent`, `idUser`) VALUES (\'folder_Actualités\', \'folder\', \'root\', '.qs($id).');';		mysqli_query($this->bd,$sql);		$sql = 'INSERT INTO `favoris` (`label`, `adresse`, `parent`, `idUser`) VALUES (\'Yahoo - Actualités\', \'http://fr.news.yahoo.com/\', \'folder_Actualités\', '.qs($id).');';		mysqli_query($this->bd,$sql);		$sql = 'INSERT INTO `favoris` (`label`, `adresse`, `parent`, `idUser`) VALUES (\'Le Figaro\', \'http://www.lefigaro.fr/\', \'folder_Actualités\', '.qs($id).');';		mysqli_query($this->bd,$sql);		$sql = 'INSERT INTO `favoris` (`label`, `adresse`, `parent`, `idUser`) VALUES (\'2424actu\', \'http://www.2424actu.fr/actualite-la-une\', \'folder_Actualités\', '.qs($id).');';		mysqli_query($this->bd,$sql);		$sql = 'INSERT INTO `favoris` (`label`, `adresse`, `parent`, `idUser`) VALUES (\'eBay\', \'http://www.ebay.fr\', \'root\', '.qs($id).');';		mysqli_query($this->bd,$sql);		$sql = 'INSERT INTO `favoris` (`label`, `adresse`, `parent`, `idUser`) VALUES (\'Leboncoin\', \'http://www.leboncoin.fr\', \'root\', '.qs($id).');';		mysqli_query($this->bd,$sql);		addLogInscription("Inscription - ".$id.", ".$mail);		//Envoi d'un mail à l'admin		htmlMail("gaetan.azema@gmail.com", "no-reply@gstart.fr", "Nouvelle inscription sur GStart", "<b>id : </b>".$id."<br/><b>mail : </b>".$mail);	}		function changePwd($idUser, $mdp){				//MAJ des favoris de base		$sql = 'UPDATE `start_users` SET  `pwd`  = \''.sha1($mdp).'\' WHERE `idUser` = \''.$idUser.'\';';		mysqli_query($this->bd,$sql) or die(mysqli_error());	}		//Renvoi des identifants par mail	function sendInfosByMail($mail){		if($this->isExistingEmail($mail)){			//On récupère les informtions						$sql = 'SELECT *  FROM `start_users`  WHERE `mail` = \''.$mail.'\'';			$result = mysqli_query($this->bd,$sql);			while($line = mysqli_fetch_array($result)){				$id = $line['idUser'];				$mdp = $line['pwd'];			}			//On envoie les informations par mail			$lien = "http://www.gstart.fr/changePwd.php?old=".$mdp;			$message = "Bonjour,<br/><br/>Votre identifiant d'accès pour vous connecter sur GStart est : <b>".$id."</b><br/>Pour modifier votre mot de passe cliquez sur le lien suivant (ou copiez-le dans la barre d'adresse de votre navigateur) : ".$lien."<br/><br/>Cordialement,<br/>Administrateur GStart";			htmlMail($mail, 'no-reply@gstart.fr', 'Rappel de vos identifiants', $message);		}	}		//Conseiller GStart à un amis	function conseil($nom, $mail){		//On envoie les informations par mail		$message = "Bonjour,<br/><br/>".$nom." vous invite à utiliser GStart et gérer vos favoris en ligne.<br/><br/>GStart est une application web qui vous permet de gérer en ligne vos favoris.<br/>Grâce à GStart accédez en un clic à tous vos sites préférés à partir de nimporte quel ordinateur relié à internet.<br/><br/><a href='http://www.gstart.fr'>Accéder à GStart</a><br/><br/>Cordialement,<br/>Administrateur GStart";		htmlMail($mail, 'no-reply@gstart.fr', $nom.' vous invite à utiliser GStart', $message);	}		function updateFavoris($newWebmail, $newBank, $newTV, $newMeteo, $idUser){		//MAJ des favoris de base		$sql = 'UPDATE `favoris` SET  `adresse`  = \''.$newWebmail.'\' WHERE `label` = \'lb_webmail\' AND `idUser` = \''.$idUser.'\';';		mysqli_query($this->bd,$sql) or die(mysqli_error());		$sql = 'UPDATE `favoris` SET `adresse` = \''.$newBank.'\' WHERE `label` = \'lb_bank\' AND `idUser` = \''.$idUser.'\';';		mysqli_query($this->bd,$sql) or die(mysqli_error());		$sql = 'UPDATE `favoris` SET `adresse` = \''.$newTV.'\' WHERE `label` = \'lb_tv\' AND `idUser` = \''.$idUser.'\';';		mysqli_query($this->bd,$sql) or die(mysqli_error());		$sql = 'UPDATE `favoris` SET `adresse` = \''.$newMeteo.'\' WHERE `label` = \'lb_meteo\' AND `idUser` = \''.$idUser.'\';';		mysqli_query($this->bd,$sql) or die(mysqli_error());	}		//Ajout d'un favoris	function addFavoris($idUser, $label, $url, $parent){		//on envlève les espaces de l'url		$url=str_replace(' ','',$url);		//on enleve les balises html si il y en a		$label = strip_tags($label);		$url = strip_tags($url);		if($parent != "root"){			if(substr($parent, 0, 7) != "folder_"){				$parent = "folder_".$parent;			}		}		if($url == "folder"){//Ajout d'un dossier			$label = "folder_".$label;		}else{//Ajout d'un favoris			//Correction de l'url			if(substr($url, 0, 7) == "http://"){				if(substr($url, 0, 14) == "http://http://"){					$url = substr($url, 7, strlen($url)-1);//Redondance				}			}else{				if(substr($url, 0, 4) == "www."){					$url = "http://".$url;//Ajout du http://				}			}			//Label vide			if($label == ""){				$label = $url;			}			//On enleve le http:// pour le label			if(substr($label, 0, 7) == "http://"){				$label = substr($label, 7, strlen($label)-1);			}		}		$exist = $this->isExistingLabel($idUser, $label);		if($exist == false){			if($label == ''){				$error = "Le nom du favoris ne doit pas être vide. Veuillez recommencer en choisissant un nom correct.";				return $error;			}else{				//Ajout du favoris				$sql = 'INSERT INTO `favoris` (`label`, `adresse`, `parent`, `idUser`) VALUES ('.qs($label).', '.qs($url).', '.qs($parent).', '.qs($idUser).');';				if(mysqli_query($this->bd,$sql) === TRUE){					return '0';				}else{					return 'Erreur sur la requête SQL : '.mysqli_error($this->bd);				}			}		}else{			if($url == "folder"){$temp="dossier";}else{$temp="favoris";}			$error = "Le ".$temp." que vous avez saisi n'a pas été enregistré car ce nom existe déjà dans vos favoris. Veuillez recommencer en choisissant un nom différent.";			return $error;		}	}		//Retourne les 20 adresses les plus marqués en favoris	function getTop20(){		$stock = array();		$sql = 'SELECT adresse FROM favoris WHERE adresse <> \'folder\'';		$result = mysqli_query($this->bd,$sql) or die(mysqli_error());		$i=0;		while($line = mysqli_fetch_array($result)){			$adr = $line['adresse'];			//On vire le http:// si il y en a un			if(substr($adr, 0, 7) == "http://"){				$adr = substr($adr, 7, strlen($adr)-1);			}			//On vire le https:// si il y en a un			if(substr($adr, 0, 8) == "https://"){				$adr = substr($adr, 8, strlen($adr)-1);			}			//On vire www. si il y en a un			if(substr($adr, 0, 4) == "www."){				$adr = substr($adr, 4, strlen($adr)-1);			}			//On prend que le début avant le /			$return = explode('/', $adr);			$adr = $return[0];			$stock[$i] = $adr;			$i++;		}				$stock2 = array();		//On initialise le comptage		foreach($stock as $cpt => $url){			$stock2[$url] = 0;		}		//On compte		foreach($stock as $cpt => $url){			$stock2[$url] += 1;		}				asort($stock2, SORT_NUMERIC);		$stock2 = array_reverse($stock2);		$stock2 = array_slice($stock2, 0, 20);		return($stock2);	}		//Retourne le contenu de la note de l'utilisateur	function getNote($idUser){				$sql = 'SELECT `note` FROM `start_users` WHERE `idUser` = \''.$idUser.'\'';		$result = mysqli_query($this->bd,$sql) or die(mysqli_error());		$res='';		while($line = mysqli_fetch_array($result)) {			$res = $line['note'];		}		if($res=='')			$res='Entrez ici vos notes ...';		return $res;	}		//Modifie le contenu de la note de l'utilisateur	function setNote($idUser, $note){				$sql = 'UPDATE start_users SET note='.$this->qs($note).' WHERE idUser = \''.$idUser.'\'';		$result = mysqli_query($this->bd,$sql) or die(mysqli_error());	}		/*fonction d'encodage contre les injections SQL*/	function qs($value, $forceString = false){		// Stripslashes		if(strtoupper($value) == "NULL")			return $value;		if(get_magic_quotes_gpc())			$value = stripslashes($value);		// Protection si ce n'est pas un entier		if($forceString || !is_numeric($value))			$value = "'".mysqli_real_escape_string($this->bd,$value)."'";		return $value;	}		//Retourne 1 si l'user veut afficher le calendrier au démarage, 0 sinon	function getDisplayCal($idUser){				$sql = 'SELECT `displayCal` FROM `start_users` WHERE `idUser` = \''.$idUser.'\'';		$result = mysqli_query($this->bd,$sql) or die(mysqli_error());		while($line = mysqli_fetch_array($result)) {			$res = $line['displayCal'];		}		return $res;	}		//Envoie 1 si l'user veut afficher le calendrier au démarage, 0 sinon	function setDisplayCal($idUser, $newDisplayCal){				$sql = 'UPDATE start_users SET displayCal=\''.$newDisplayCal.'\' WHERE idUser = \''.$idUser.'\'';		$result = mysqli_query($this->bd,$sql) or die(mysqli_error());	}		//Retourne le numéro du thème de calendrier de l'utilisateur	function getThemeCal($idUser){				$sql = 'SELECT `themeCal` FROM `start_users` WHERE `idUser` = \''.$idUser.'\'';		$result = mysqli_query($this->bd,$sql) or die(mysqli_error());		$res='';		while($line = mysqli_fetch_array($result)) {			$res = $line['themeCal'];		}		return $res;	}		//Modifie le numéro du thème de calendrier de l'utilisateur	function setThemeCal($idUser, $theme){				$sql = 'UPDATE start_users SET themeCal='.$this->qs($theme).' WHERE idUser = \''.$idUser.'\'';		$result = mysqli_query($this->bd,$sql) or die(mysqli_error());	}		//Retourne le nombre total d'utilisateurs de Gtart	function getNbUsers(){				$sql = 'SELECT count(idUser) FROM start_users';		$result = mysqli_query($this->bd,$sql) or die(mysqli_error());		$res=0;		while($line = mysqli_fetch_array($result)) {			$res = $line[0];		}		return $res;	}		//Retourne les utilisateurs qui n'ont pas reçus le mailing	function getUsersNotSended($limit = 0){		$res = array();				$sql = 'SELECT idUser FROM start_users WHERE mail_sended = 0';		if($limit != 0)			$sql .= ' LIMIT 0, '.$limit;		$result = mysqli_query($this->bd,$sql) or die(mysqli_error());		$i=0;		while($line = mysqli_fetch_array($result)) {			$res[$i] = $line[0];			$i++;		}		return $res;	}		//Marque l'utilisateur envoyé pour le mailing	function markAsSended($idUser){				$sql = 'UPDATE start_users SET mail_sended=1 WHERE idUser = \''.$idUser.'\'';		$result = mysqli_query($this->bd,$sql) or die(mysqli_error());	}}?>